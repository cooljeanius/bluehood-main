n
<?php
	include('/var/www/twiverse.php');
	$s = [
		'notfound' => ['ja' => "コミュニティが存在しません。", 'en' => "The community was not found. ", ],
		'requirement' => [
			'ja' => "コミュニティに投稿するには、スクリーンショットを添付する必要があります。",
			'en' => "To post this community, please attach screenshot. ",
		],
		//'' => ['ja' => "", 'en' => ""],
	];

	unset($_SESSION['post_image']);

	function detect($filename){
	$twitter = twitter_start();
	$image = file_get_contents('noimage.jpg');
	if ($filename){
		unset($name);
		unset($comm_id);
		unset($soft_id);
		$exif = exif_read_data($filename);
		if (useragent() == 'wiiu'){
			$soft_id = 'WU'.substr($filename, -9, 5);
		}else if ($exif['Model'] == 'Nintendo 3DS') do{
			if (strlen($exif['Software']) != 5){
				//die('<div id="err">この画像は使用できません。</div>');
				$comm_id = 'default0';
				$name = '未分類';
				break;
			}
			$soft_id = '3D'.$exif['Software'];
		}while(0); else if ($exif['Model'] == 'PlayStation(R)Vita'){
			$soft_id = 'PV'.substr(strstr($exif['MakerNote'], 'GPNM'), 5, 9);
			$name = mb_substr(twitter_trimhash(mysql_escape_string(substr(strstr($exif['MakerNote'], 'ALBM'), 5, -1))), 0, 25);

			mysql_start();
                        $res = mysql_fetch_assoc(mysql_query("select name from soft_id2name where id = '".$soft_id."'"));
			mysql_close();
                        if (!$res['name']) make_comm($soft_id, $name);
		}else if ($exif['Model'] == 'NintendoDS'){
			if (strlen($exif['Software']) != 4){
                                //die('<div id="err">この画像は使用できません。</div>');
                                $comm_id = 'default0';
                                $name = '未分類';
                                break;
                        }
                        $soft_id = 'DS'.$exif['Software'];
		}else if ($exif['Model'] == 'PlayStation(R)4'){
                        $soft_id = 'P4'.substr(strstr($exif['MakerNote'], 'GPNM'), 5, 9);
                        $name = mb_substr(twitter_trimhash(mysql_escape_string(substr(strstr($exif['MakerNote'], 'ALBM'), 5, -1))), 0, 25);

                        mysql_start();
                        $res = mysql_fetch_assoc(mysql_query("select name from soft_id2name where id = '".$soft_id."'"));
                        mysql_close();
                        if (!$res['name']) make_comm($soft_id, $name);
                }else if (0){	// AI ディテクタ
		}else{
			/*die('<div id="err">Wii U、3DS以外の端末からはスクリーンショットを投稿できません。</div>');*/
			$comm_id = 'default0';
			$name = '未分類';
		}

		$image = file_get_contents($filename);
		$_SESSION['post_image'] = base64_encode($image);
	}else if (isset($_POST['selalbum'])){
		$twitter = twitter_start();
		$status = $twitter->get('statuses/show', ['id' => $_POST['selalbum']]);
		$texts = explode(' ', str_replace('@home ', '', $status->text));
		if (hash('crc32b', $texts[0]) != $texts[1]) die('<div id="err">ソフト情報を認識できないため、このアルバムは使用できません。</div>');
		$soft_id = $texts[0];
		if (strtotime($status->created_at) < 1516037892) $soft_id = 'WU'.$soft_id;
		$image = file_get_contents($status->entities->media[0]->media_url_https);
		$_SESSION['post_image'] = base64_encode($image);
	}else{	// 画像を外す
		unset($_SESSION['post_image']);
	}

	if ((!isset($comm_id))&&(isset($soft_id))){
		mysql_start();
               	$res = mysql_fetch_assoc(mysql_query("select name from soft_id2name where id = '".$soft_id."'"));
		if ($res['name']){	/* ゲームが登録済み */
			//die('<div id="err">'.$soft_id.'登録あり</div>');
        	        $res = mysql_fetch_assoc(mysql_query("select id from comm where soft_id = '".$soft_id."'"));
			$comm_id = $res['id'];

			$res = mysql_fetch_assoc(mysql_query("select name from comm where id = '".$comm_id."'"));
		        $name = $res['name'];
		}else{	/* ゲームが未登録 */
			//die('<div id="err">'.$soft_id.'登録なし</div>');
			unset($comm_id);

	                $res = mysql_fetch_assoc(mysql_query("select default_name from soft_id2name where id = '".$soft_id."'"));
	                if ($res['default_name']) $name = $res['default_name'];
			else $name = '';
		}
       	        mysql_close();
	}

	try{
	$option = [];

	// リクエスト用のJSONを作成
	if (isset($_SESSION['post_image'])){
		$json = json_encode( array(
			"requests" => array(
				array(
					"image" => array(
						"content" => $_SESSION['post_image'],
					) ,
					"features" => array(
						array(
							"type" => "WEB_DETECTION" ,
							"maxResults" => 5 ,
						) ,
					) ,
				) ,
			) ,
		) ) ;
		// リクエストを実行
		$curl = curl_init() ;
		curl_setopt( $curl, CURLOPT_URL, "https://vision.googleapis.com/v1/images:annotate?key=".GOOGLE_CLOUD_PLATFORM_KEY) ;
		curl_setopt( $curl, CURLOPT_HEADER, true ) ; 
		curl_setopt( $curl, CURLOPT_CUSTOMREQUEST, "POST" ) ;
		curl_setopt( $curl, CURLOPT_HTTPHEADER, array( "Content-Type: application/json" ) ) ;
		curl_setopt( $curl, CURLOPT_SSL_VERIFYPEER, false ) ;
		curl_setopt( $curl, CURLOPT_RETURNTRANSFER, true ) ;
		if( isset($referer) && !empty($referer) ) curl_setopt( $curl, CURLOPT_REFERER, $referer ) ;
		curl_setopt( $curl, CURLOPT_TIMEOUT, 15 ) ;
		curl_setopt( $curl, CURLOPT_POSTFIELDS, $json ) ;
		$res1 = curl_exec( $curl ) ;
		$res2 = curl_getinfo( $curl ) ;
		curl_close( $curl ) ;
		// 取得したデータ
		$json = substr( $res1, $res2["header_size"] ) ;				// 取得したJSON
		$header = substr( $res1, 0, $res2["header_size"] ) ;		// レスポンスヘッダー
		$res = json_decode($json);
		foreach($res->responses[0]->webDetection->webEntities as $webentity){
			$hashtag = '#'.twitter_trimhash(/*strtolower(*/$webentity->description/*)*/);
			array_push($option, $hashtag.' ');
		}
	}

	if (isset($comm_id)){
		if ($comm_id == 'default0'){	// 未分類コミュニティ
			$collection_id = ALL_POSTS;
		}else{
                	mysql_start();
       	        	$res = mysql_fetch_assoc(mysql_query("select collection_id from comm where id = '".$comm_id."'"));
			mysql_throw();
       	        	$collection_id = $res['collection_id'];
       	        	mysql_close();
		}
	}else $collection_id = ALL_POSTS;
	$res = $twitter->get('collections/entries', ['id' => 'custom-'.$collection_id, 'count' => '200']);
	twitter_throw();
	$search = $res->objects->tweets;
	$hashcnts = [];
	$topstatus = [];
	foreach($search as $status){
		foreach($status->entities->hashtags as $hashtag){
			if (!$hashcnts[$hashtag->text]){
				$hashcnts[$hashtag->text] = 0;
				$topstatus[$hashtag->text] = $status;
			}
			$hashcnts[$hashtag->text]++;
		}
	}
	arsort($hashcnts);
	foreach($hashcnts as $text => $cnt){
		array_push($option, '#'.$text.' ');
	}

	/*$follows = $twitter->get('friends/list', ['screen_name' => $_SESSION['twitter']['account']['user']->screen_name, 'count' => 200])->users;
        foreach($follows as $user){
		array_push($option, '@'.$user->screen_name.' ');
        }*/

	}catch(Exception $e){
		die('<div id="err">エラーが発生しました。'.$e->getMessage().'</div>');
	}

	$ret = [];
	$ret['data'] = base64_encode($image);
	$ret['option'] = $option;
	if (isset($soft_id)) $ret['data'] = $soft_id;
	if (isset($comm_id)) $ret['data'] = $comm_id;
	if (isset($name)) $ret['data'] = $name;
	/* レスポンス
	1. err -> エラー出力
	2. comm_idあり、コミュニティ名、image -> コミュニティ選択済み
	3. ソフト名、image -> コミュニティ作成
	4. image -> 画像を外す
	*/

	return $ret;
	}

        echo '<script type="text/javascript"> var comm_id = undefined; var comm_name = undefined; var thumb_data = undefined; </script>';
	if (isset($_GET['comm_id'])){
                mysql_start();
                $res = mysql_fetch_assoc(mysql_query("select name, list_id from comm where id = '".$_GET['comm_id']."'"));
                if (empty($res)) die(s($s['notfound']));
                $comm_name = $res['name'];
                mysql_close();

		$twitter_admin = twitter_admin();
		if (isset($twitter_admin->get('lists/members/show', ['list_id' => $res['list_id'], 'screen_name' => $_SESSION['twitter']['account']['user']->screen_name])->id)) echo '<script type="text/javascript"> var comm_id = "'.$_GET['comm_id'].'";var comm_name = "'.$comm_name.'"; </script>';
		else echo '<script type="text/javascript"> alert("'.s($s['requirement']).'"); </script>';
        }

        echo '<script>var draft_draw = undefined; </script>';
	mysql_start();
        $res = mysql_fetch_assoc(mysql_query("select draft_draw from user where screen_name = '".$_SESSION['twitter']['screen_name']."'"));
        if (!empty($res['draft_draw'])) echo '<script>draft_draw = "'.$res['draft_draw'].'"; </script>';
        mysql_close();

	if (isset($_GET['album'])){
		/* thumbup.php */
	}

        if (isset($comm_id)) echo '<script>comm_id = "'.$comm_id.'"; </script>';
        if (isset($comm_name)) echo '<script>comm_name = "'.$comm_name.'"; </script>';
        if (isset($image)) echo '<script>thumb_data = "'.$image.'"; </script>';
?>

<?php
?>
